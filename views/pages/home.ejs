<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youtube Reverse Search</title>
    <link rel="stylesheet" href="/css/base.css">
</head>

<body>
    <form id="video_form">
        <input type="text" id="yt_url" name="yt_url" placeholder="https://www.youtube.com/watch?v=ebeNeQFUMa0&t=62s" required>
        <input type="submit" value="submit">
    </form>


    <div id="vid_container">

    </div>
    <form id="time_form" hidden>
        <input type="text" id="time_stmp" name="time_stmp" placeholder="4:43" required>
        <input type="submit" value="Seek Time Frame">
    </form>

    <button id="capture_btn" onclick="capture()" hidden>Capture</button>
    <canvas id="canvas" style="overflow:auto"></canvas>
    <a id="down_link" download="screenshot.png" href="">
        <button id="down_btn" hidden>Download Screenchot</button>
    </a>


    <script>
        var img_blob;

        function add_video(youtubeID) {
            // add a video containershow the capture button
            $("#vid_container").append(
                `<video controls width="250" height="200" src="/get_video/${youtubeID}" id="video"> 
                    This browser does not support the HTML5 video element.
                </video>`
            );
            // show the capture and the download screenshot button and the timestamp button
            $("#capture_btn").show();
            $("#down_btn").show();
            $("#time_form").show();
        }

        function capture() {
            var canvas = document.getElementById('canvas');
            var video = document.getElementById('video');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            canvas.toBlob((blob) => {
                img_blob = blob;
                link = (window.URL ? URL : webkitURL).createObjectURL(blob);
                $("#down_link").attr('href', link);
            });
        }

        $("#video_form").submit(function (event) {
            // we prevent the form from making a post request
            event.preventDefault();
            // get the youtube_url from the form
            let form_data = $(this).serializeArray();
            // the form will only contain one item at index 0
            let url = form_data[0].value
            // the first index after the split will always be youtube so we know the second is query params
            query_params = new URLSearchParams(url.split("watch?")[1]);
            // call the add_video function with the video id parameter retreived from the url
            add_video(query_params.get("v"));
        })

        function send_blob(img_blob) {
            var req = new XMLHttpRequest();
            req.open("POST", "/reverse_search", true);
            req.onload = function (event) {
                // Uploaded.
                console.log("uploaded");
            };
            req.send(img_blob);
        }

        $("#time_form").submit(function (event) {
            // we prevent the form from making a post request
            event.preventDefault();
            // get the time stamp from the form
            let form_data = $(this).serializeArray();
            // the form will only contain one item at index 0
            let ts = form_data[0].value
            // calculate the seconds from the timestamp
            let times = ts.split(":");
            let seconds = 60*parseInt(times[0]) + parseInt(times[1]);
            // get the video element
            //let video = $("#vid_container video");
            let video = document.getElementById('video');
            video.currentTime = seconds;
            video.play();
        })

    </script>
</body>

</html>