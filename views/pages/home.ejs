<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youtube Reverse Search</title>
</head>

<body>
    <form id="video_form">
        <input type="text" id="yt_url" name="yt_url" placeholder="https://www.youtube.com/watch?v=ebeNeQFUMa0&t=62s">
        <input type="submit" value="submit">
    </form>


    <div id="vid_container">

    </div>

    <button id="capture_btn" onclick="capture()" hidden>Capture</button>
    <canvas id="canvas" style="overflow:auto"></canvas>
    <a id="down_link" download="screenshot.png" href="">
        <button id="down_btn" hidden>Download Screenchot</button>
    </a>


    <script>
        var img_blob;

        function add_video(youtubeID) {
            // add a video containershow the capture button
            $("#vid_container").append(
                `<video controls width="250" height="200" src="/get_video/${youtubeID}" id="video"> 
                    This browser does not support the HTML5 video element.
                </video>`
            );
            // show the capture and the download screenshot button
            $("#capture_btn").show();
            $("#down_btn").show();
        }


        function capture() {
            var canvas = document.getElementById('canvas');
            var video = document.getElementById('video');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            canvas.toBlob((blob) => {
                img_blob = blob;
                link = (window.URL ? URL : webkitURL).createObjectURL(blob);
                $("#down_link").attr('href', link);
            });
        }

        $("#video_form").submit(function (event) {
            // we prevent the form from making a post request
            event.preventDefault();
            // get the youtube_url from the form
            let form_data = $(this).serializeArray();
            // the form will only contain one item at index 0
            url = form_data[0].value
            // the first index after the split will always be youtube so we know the second is query params
            query_params = new URLSearchParams(url.split("watch?")[1]);
            // call the add_video function with the video id parameter retreived from the url
            add_video(query_params.get("v"));
        })

        function send_blob(img_blob) {
            // var fd = new FormData();
            // fd.append('fname', 'sc.png');
            // fd.append('data', img_blob);
            // $.ajax({
            //     type: 'POST',
            //     url: '/image',
            //     data: fd,
            //     processData: false,
            //     contentType: false
            // }).done(function (data) {
            //     console.log(data);
            // });

            // let formData = new FormData();
            // console.log("this blob:", img_blob);
            // formData.append("files[]", img_blob, "img.png");
            // formData.append("test", "test");
            // $.ajax({
            //     url: '/image',
            //     type: 'POST',
            //     data: formData,
            //     success: function (data) {
            //         console.log(data);
            //     },
            //     error: function (err) {
            //         console.log(err);
            //     },
            //     cache: false,
            //     contentType: false,
            //     processData: false
            // });

            var oReq = new XMLHttpRequest();
            oReq.open("POST", "/image", true);
            oReq.onload = function (oEvent) {
                // Uploaded.
                console.log("uploaded");
            };

            //var blob = new Blob(['abc123'], { type: 'text/plain' });

            oReq.send(img_blob);
        }


    </script>
</body>

<!-- ffmpeg command to get the 150th frame from video
ffmpeg -i test_video.mp4 -vf "select=gte(n\, 150)" -vframes 1 ./test_image.jpg -->

</html>